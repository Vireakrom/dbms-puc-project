{% extends "student/student_base.html" %}

{% block title %}Student Dashboard{% endblock %}
{% block header_title %}Student Dashboard{% endblock %}

{% block content %}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

<style>
    body {
        background: #f4f6fb;
    }

    /* ===========================
   PAGE HEADER
=========================== */
    .page-header {
        margin-bottom: 30px;
    }

    .page-header h2 {
        font-size: 28px;
        font-weight: 700;
        color: #2c3e50;
        margin-bottom: 8px;
    }

    .page-header p {
        color: #7f8c8d;
        font-size: 16px;
    }

    /* ===========================
   QUIZ CARDS GRID
=========================== */
    .quizzes-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 25px;
        margin-top: 25px;
    }

    .quiz-card {
        background: white;
        border-radius: 18px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        padding: 25px;
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
        overflow: hidden;
    }

    .quiz-card:hover {
        transform: translateY(-6px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
    }

    .quiz-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 5px;
        background: linear-gradient(90deg, #00a8ff, #0097e6);
    }

    .quiz-card.exam-type::before {
        background: linear-gradient(90deg, #e74c3c, #c0392b);
    }

    .quiz-card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 15px;
    }

    .quiz-badge {
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .badge-exam {
        background: #ffe5e5;
        color: #e74c3c;
    }

    .badge-practice {
        background: #e3f2fd;
        color: #0097e6;
    }

    .badge-status {
        background: #d1f2eb;
        color: #27ae60;
        margin-left: 8px;
    }

    .badge-status.completed {
        background: #f0f0f0;
        color: #95a5a6;
    }

    .quiz-title {
        font-size: 20px;
        font-weight: 700;
        color: #2c3e50;
        margin-bottom: 8px;
        margin-top: 10px;
    }

    .quiz-subject {
        color: #00a8ff;
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .quiz-details {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
        padding-top: 15px;
        border-top: 1px solid #ecf0f1;
    }

    .quiz-detail-item {
        display: flex;
        align-items: center;
        gap: 8px;
        color: #7f8c8d;
        font-size: 14px;
    }

    .quiz-detail-item i {
        color: #00a8ff;
        font-size: 16px;
    }

    .quiz-actions {
        display: flex;
        gap: 10px;
    }

    .btn-start-quiz {
        flex: 1;
        padding: 12px 20px;
        border: none;
        border-radius: 10px;
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    .btn-primary-quiz {
        background: linear-gradient(135deg, #00a8ff, #0097e6);
        color: white;
    }

    .btn-primary-quiz:hover {
        background: linear-gradient(135deg, #0097e6, #0086cc);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 168, 255, 0.3);
    }

    .btn-danger-quiz {
        background: linear-gradient(135deg, #e74c3c, #c0392b);
        color: white;
    }

    .btn-danger-quiz:hover {
        background: linear-gradient(135deg, #c0392b, #a93226);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
    }

    .btn-disabled {
        background: #ecf0f1;
        color: #95a5a6;
        cursor: not-allowed;
    }

    .btn-disabled:hover {
        transform: none;
        box-shadow: none;
    }

    /* ===========================
   EMPTY STATE
=========================== */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        background: white;
        border-radius: 18px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .empty-state i {
        font-size: 64px;
        color: #bdc3c7;
        margin-bottom: 20px;
    }

    .empty-state h3 {
        color: #2c3e50;
        margin-bottom: 10px;
    }

    .empty-state p {
        color: #7f8c8d;
    }

    /* ===========================
   FILTER SECTION
=========================== */
    .filter-section {
        display: flex;
        gap: 15px;
        margin-bottom: 25px;
        flex-wrap: wrap;
    }

    .filter-btn {
        padding: 10px 20px;
        border: 2px solid #ecf0f1;
        background: white;
        border-radius: 10px;
        font-weight: 600;
        color: #7f8c8d;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .filter-btn:hover,
    .filter-btn.active {
        border-color: #00a8ff;
        color: #00a8ff;
        background: #e3f2fd;
    }
</style>

<div class="page-header">
    <h2><i class="bi bi-clipboard-check"></i> Available Quizzes</h2>
    <p>Select a quiz to start practicing or take an exam</p>
</div>

<!-- Filter Section -->
<div class="filter-section">
    <button class="filter-btn active" onclick="filterQuizzes('all')">
        <i class="bi bi-grid-3x3-gap"></i> All Quizzes
    </button>
    <button class="filter-btn" onclick="filterQuizzes('quiz')">
        <i class="bi bi-question-circle"></i> Quiz
    </button>
    <button class="filter-btn" onclick="filterQuizzes('midterm')">
        <i class="bi bi-journal-text"></i> Midterm
    </button>
    <button class="filter-btn" onclick="filterQuizzes('final')">
        <i class="bi bi-award"></i> Final
    </button>
    <button class="filter-btn" onclick="filterQuizzes('assignment')">
        <i class="bi bi-clipboard-check"></i> Assignment
    </button>
    <button class="filter-btn" onclick="filterQuizzes('practice')">
        <i class="bi bi-pencil-square"></i> Practice
    </button>
</div>

<!-- Quizzes Grid Container -->
<div class="quizzes-container" id="quizzes-container">
    <!-- Quiz cards will be dynamically generated here -->
</div>

<script>
    // ===========================
    // Available Quizzes (from backend)
    // ===========================
    const availableQuizzes = {{ available_quizzes | tojson | safe }} || [];

    // Normalize backend fields to UI expectations
    availableQuizzes.forEach(q => {
        q.questionCount = q.question_count || q.questionCount || 0;
        q.status = q.status || 'available';
        q.dueDate = q.end_time || q.dueDate || null;
        q.startDate = q.start_time || q.startDate || null;
        q.duration = q.duration || 30;
        q.type = (q.type || 'quiz').toLowerCase();
        q.displayType = q.display_type || (q.type ? (q.type.charAt(0).toUpperCase() + q.type.slice(1)) : 'Quiz');
    });

    // ===========================
    // GLOBAL FILTER STATE
    // ===========================
    let currentFilter = 'all';

    // ===========================
    // RENDER QUIZ CARDS
    // ===========================
    function renderQuizzes(quizzes) {
        const container = document.getElementById('quizzes-container');

        if (quizzes.length === 0) {
            container.innerHTML = `
            <div class="empty-state" style="grid-column: 1 / -1;">
                <i class="bi bi-inbox"></i>
                <h3>No Quizzes Found</h3>
                <p>There are no quizzes matching your current filter.</p>
            </div>
        `;
            return;
        }

        container.innerHTML = quizzes.map(quiz => {
            let statusLabel = '● Available';
            let statusClass = '';
            let disabled = false;

            if (quiz.status === 'completed') {
                statusLabel = '✓ Completed';
                statusClass = 'completed';
                disabled = true;
            } else if (quiz.status === 'upcoming') {
                statusLabel = `Opens ${quiz.startDate ? formatDateTime(quiz.startDate) : ''}`;
                disabled = true;
            } else if (quiz.status === 'closed') {
                statusLabel = 'Closed';
                disabled = true;
            }

            const typeClassMap = {
                quiz: 'badge-practice',
                practice: 'badge-practice',
                midterm: 'badge-exam',
                final: 'badge-exam',
                assignment: 'badge-exam'
            };
            const typeClass = typeClassMap[quiz.type] || 'badge-practice';
            const displayType = quiz.displayType || (quiz.type ? (quiz.type.charAt(0).toUpperCase() + quiz.type.slice(1)) : 'Quiz');

            return `
        <div class="quiz-card ${['midterm', 'final', 'assignment'].includes(quiz.type) ? 'exam-type' : ''}">
            <div class="quiz-card-header">
                <span class="quiz-badge ${typeClass}">
                    ${displayType}
                </span>
                <span class="quiz-badge badge-status ${statusClass}">
                    ${statusLabel}
                </span>
            </div>

            <h3 class="quiz-title">${quiz.title}</h3>

            <div class="quiz-subject">
                <i class="bi bi-book"></i>
                ${quiz.subject}
            </div>

            <div class="quiz-details">
                <div class="quiz-detail-item">
                    <i class="bi bi-clock"></i>
                    <span>${quiz.duration} min</span>
                </div>
                <div class="quiz-detail-item">
                    <i class="bi bi-list-check"></i>
                    <span>${quiz.questionCount} questions</span>
                </div>
            </div>

            ${quiz.startDate ? `
                <div style="margin-bottom: 10px; color: #16a085; font-size: 13px; font-weight: 600;">
                    <i class="bi bi-calendar-event"></i> Opens: ${formatDateTime(quiz.startDate)}
                </div>
            ` : ''}

            ${quiz.dueDate ? `
                <div style="margin-bottom: 15px; color: #e74c3c; font-size: 13px; font-weight: 600;">
                    <i class="bi bi-calendar-event"></i> Due: ${formatDateTime(quiz.dueDate)}
                </div>
            ` : ''}

            <div class="quiz-actions">
                ${disabled ? `
                    <button class="btn-start-quiz btn-disabled" disabled>
                        <i class="bi bi-slash-circle"></i>
                        ${quiz.status === 'upcoming' ? 'Not open yet' : 'Unavailable'}
                    </button>
                ` : `
                    <button class="btn-start-quiz ${['midterm', 'final', 'assignment'].includes(quiz.type) ? 'btn-danger-quiz' : 'btn-primary-quiz'}"
                            onclick="startQuiz(${quiz.id}, '${quiz.type}')">
                        <i class="bi bi-play-circle"></i>
                        Start ${displayType}
                    </button>
                `}
            </div>
        </div>
    `;
        }).join('');
    }

    // ===========================
    // FILTER QUIZZES
    // ===========================
    function filterQuizzes(type) {
        currentFilter = type;

        // Update active button
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.closest('.filter-btn').classList.add('active');

        // Filter quizzes
        let filteredQuizzes = availableQuizzes;
        if (type !== 'all') {
            filteredQuizzes = availableQuizzes.filter(q => (q.type || '').toLowerCase() === type.toLowerCase());
        }

        renderQuizzes(filteredQuizzes);
    }

    // ===========================
    // START QUIZ
    // ===========================
    function startQuiz(quizId, quizType) {
        const quizData = availableQuizzes.find(q => q.id === quizId);
        if (!quizData || quizData.status !== 'available') {
            alert('This quiz is not available to start right now.');
            return;
        }

        sessionStorage.setItem('currentQuiz', JSON.stringify(quizData));
        window.location.href = `/student/quiz?id=${quizId}&type=${quizType}`;
    }

    // ===========================
    // UTILITY: FORMAT DATE
    // ===========================
    function formatDate(dateString) {
        const date = new Date(dateString);
        const options = { year: 'numeric', month: 'short', day: 'numeric' };
        return date.toLocaleDateString('en-US', options);
    }

    function formatDateTime(dateString) {
        const date = new Date(dateString);
        return date.toLocaleString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    // ===========================
    // INITIALIZE ON PAGE LOAD
    // ===========================
    document.addEventListener('DOMContentLoaded', function () {
        renderQuizzes(availableQuizzes);
    });
</script>

{% endblock %}