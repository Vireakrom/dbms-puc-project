{% extends "student/student_base.html" %}

{% block title %}Quiz{% endblock %}
{% block header_title %}Quiz{% endblock %}

{% block content %}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

<style>
body {
    background: #f4f6fb;
    overflow-x: hidden;
}

/* ===========================
   COMMON STYLES
=========================== */
.section-hidden {
    display: none !important;
}

.section-visible {
    display: block !important;
}

/* ===========================
   QUIZ INTRO SECTION
=========================== */
#quiz-intro {
    max-width: 800px;
    margin: 0 auto;
    background: white;
    border-radius: 18px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    padding: 40px;
}

.intro-header {
    text-align: center;
    margin-bottom: 40px;
    padding-bottom: 30px;
    border-bottom: 2px solid #ecf0f1;
}

.intro-header h1 {
    font-size: 32px;
    font-weight: 700;
    color: #2c3e50;
    margin-bottom: 10px;
}

.intro-badge {
    display: inline-block;
    padding: 8px 20px;
    border-radius: 25px;
    font-size: 14px;
    font-weight: 600;
    text-transform: uppercase;
    margin-top: 15px;
}

.intro-badge.exam {
    background: #ffe5e5;
    color: #e74c3c;
}

.intro-badge.practice {
    background: #e3f2fd;
    color: #0097e6;
}

.quiz-info-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
    margin-bottom: 40px;
}

.info-card {
    background: #f8f9fa;
    padding: 25px;
    border-radius: 15px;
    text-align: center;
    border: 2px solid #ecf0f1;
}

.info-card i {
    font-size: 36px;
    color: #00a8ff;
    margin-bottom: 12px;
}

.info-card h3 {
    font-size: 28px;
    font-weight: 700;
    color: #2c3e50;
    margin-bottom: 5px;
}

.info-card p {
    color: #7f8c8d;
    font-size: 14px;
    margin: 0;
}

.instructions-section {
    background: #fff9e6;
    border-left: 4px solid #f39c12;
    padding: 25px;
    border-radius: 10px;
    margin-bottom: 30px;
}

.instructions-section h3 {
    color: #2c3e50;
    font-size: 20px;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.instructions-section ul {
    margin: 0;
    padding-left: 20px;
}

.instructions-section li {
    color: #555;
    margin-bottom: 10px;
    line-height: 1.6;
}

.btn-start-quiz-intro {
    width: 100%;
    padding: 18px;
    border: none;
    border-radius: 12px;
    font-size: 18px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
}

.btn-start-exam {
    background: linear-gradient(135deg, #e74c3c, #c0392b);
    color: white;
}

.btn-start-exam:hover {
    background: linear-gradient(135deg, #c0392b, #a93226);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
}

.btn-start-practice {
    background: linear-gradient(135deg, #00a8ff, #0097e6);
    color: white;
}

.btn-start-practice:hover {
    background: linear-gradient(135deg, #0097e6, #0086cc);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 168, 255, 0.4);
}

/* ===========================
   QUIZ LOADING SECTION
=========================== */
#quiz-loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 500px;
}

.loading-spinner {
    width: 80px;
    height: 80px;
    border: 8px solid #ecf0f1;
    border-top: 8px solid #00a8ff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.loading-text {
    margin-top: 30px;
    font-size: 18px;
    color: #7f8c8d;
    font-weight: 600;
}

/* ===========================
   QUIZ CONTAINER SECTION
=========================== */
#quiz-container {
    max-width: 900px;
    margin: 0 auto;
}

.quiz-header {
    background: white;
    padding: 20px 30px;
    border-radius: 18px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    margin-bottom: 25px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: sticky;
    top: 0;
    z-index: 50;
}

.quiz-progress {
    display: flex;
    align-items: center;
    gap: 20px;
}

.question-counter {
    font-size: 16px;
    font-weight: 700;
    color: #2c3e50;
}

.timer-display {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 20px;
    background: #f8f9fa;
    border-radius: 10px;
    font-size: 18px;
    font-weight: 700;
    color: #2c3e50;
}

.timer-display.warning {
    background: #ffe5e5;
    color: #e74c3c;
    animation: pulse 1s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

.timer-display i {
    font-size: 20px;
}

.auto-save-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    color: #27ae60;
    font-weight: 600;
}

.auto-save-indicator i {
    animation: fadeInOut 2s infinite;
}

@keyframes fadeInOut {
    0%, 100% { opacity: 0.3; }
    50% { opacity: 1; }
}

.question-card {
    background: white;
    padding: 35px;
    border-radius: 18px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    margin-bottom: 25px;
}

.question-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 25px;
}

.question-number {
    background: #00a8ff;
    color: white;
    padding: 8px 16px;
    border-radius: 10px;
    font-weight: 700;
    font-size: 14px;
}

.question-type {
    background: #f8f9fa;
    padding: 6px 14px;
    border-radius: 8px;
    font-size: 12px;
    color: #7f8c8d;
    font-weight: 600;
    text-transform: uppercase;
}

.question-text {
    font-size: 20px;
    color: #2c3e50;
    font-weight: 600;
    margin-bottom: 30px;
    line-height: 1.6;
}

.options-container {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.option-item {
    background: #f8f9fa;
    padding: 18px 25px;
    border-radius: 12px;
    border: 2px solid #ecf0f1;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 15px;
}

.option-item:hover {
    border-color: #00a8ff;
    background: #e3f2fd;
    transform: translateX(5px);
}

.option-item.selected {
    background: #e3f2fd;
    border-color: #00a8ff;
    border-width: 3px;
}

.option-item.correct {
    background: #d1f2eb;
    border-color: #27ae60;
    border-width: 3px;
}

.option-item.incorrect {
    background: #ffe5e5;
    border-color: #e74c3c;
    border-width: 3px;
}

.option-radio {
    width: 24px;
    height: 24px;
    border: 2px solid #bdc3c7;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.option-item.selected .option-radio {
    border-color: #00a8ff;
    background: #00a8ff;
}

.option-item.selected .option-radio::after {
    content: 'âœ“';
    color: white;
    font-size: 14px;
    font-weight: 700;
}

.option-item.correct .option-radio {
    border-color: #27ae60;
    background: #27ae60;
}

.option-item.incorrect .option-radio {
    border-color: #e74c3c;
    background: #e74c3c;
}

.option-text {
    font-size: 16px;
    color: #2c3e50;
    font-weight: 500;
}

.practice-feedback {
    margin-top: 20px;
    padding: 20px;
    border-radius: 12px;
    display: none;
}

.practice-feedback.correct {
    background: #d1f2eb;
    border-left: 4px solid #27ae60;
    display: block;
}

.practice-feedback.incorrect {
    background: #ffe5e5;
    border-left: 4px solid #e74c3c;
    display: block;
}

.practice-feedback h4 {
    margin: 0 0 8px 0;
    font-size: 16px;
    font-weight: 700;
}

.practice-feedback.correct h4 {
    color: #27ae60;
}

.practice-feedback.incorrect h4 {
    color: #e74c3c;
}

.practice-feedback p {
    margin: 0;
    color: #555;
    font-size: 14px;
}

.quiz-navigation {
    display: flex;
    gap: 15px;
    margin-top: 30px;
}

.btn-nav {
    flex: 1;
    padding: 15px;
    border: none;
    border-radius: 12px;
    font-weight: 700;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
}

.btn-previous {
    background: #ecf0f1;
    color: #2c3e50;
}

.btn-previous:hover {
    background: #bdc3c7;
}

.btn-previous:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.btn-check-answer {
    background: linear-gradient(135deg, #f39c12, #e67e22);
    color: white;
}

.btn-check-answer:hover {
    background: linear-gradient(135deg, #e67e22, #d35400);
    transform: translateY(-2px);
}

.btn-next {
    background: linear-gradient(135deg, #00a8ff, #0097e6);
    color: white;
}

.btn-next:hover {
    background: linear-gradient(135deg, #0097e6, #0086cc);
    transform: translateY(-2px);
}

.btn-submit {
    background: linear-gradient(135deg, #e74c3c, #c0392b);
    color: white;
}

.btn-submit:hover {
    background: linear-gradient(135deg, #c0392b, #a93226);
    transform: translateY(-2px);
}

.question-palette {
    background: white;
    padding: 25px;
    border-radius: 18px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

.palette-header {
    font-size: 18px;
    font-weight: 700;
    color: #2c3e50;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.palette-grid {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 10px;
}

.palette-item {
    aspect-ratio: 1;
    border: 2px solid #ecf0f1;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease;
    background: white;
    color: #7f8c8d;
}

.palette-item:hover {
    border-color: #00a8ff;
    transform: scale(1.1);
}

.palette-item.answered {
    background: #d1f2eb;
    border-color: #27ae60;
    color: #27ae60;
}

.palette-item.current {
    background: #00a8ff;
    border-color: #00a8ff;
    color: white;
}

.palette-legend {
    margin-top: 20px;
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    color: #7f8c8d;
}

.legend-box {
    width: 20px;
    height: 20px;
    border-radius: 6px;
    border: 2px solid #ecf0f1;
}

.legend-box.answered {
    background: #d1f2eb;
    border-color: #27ae60;
}

.legend-box.current {
    background: #00a8ff;
    border-color: #00a8ff;
}
</style>

<!-- ===========================
     SECTION 1: QUIZ INTRO
=========================== -->
<div id="quiz-intro" class="section-visible">
    <div class="intro-header">
        <h1 id="intro-title">Quiz Title</h1>
        <div id="intro-badge" class="intro-badge">Quiz Type</div>
    </div>

    <div class="quiz-info-grid">
        <div class="info-card">
            <i class="bi bi-clock-history"></i>
            <h3 id="intro-duration">60</h3>
            <p>Minutes</p>
        </div>
        <div class="info-card">
            <i class="bi bi-list-check"></i>
            <h3 id="intro-questions">30</h3>
            <p>Questions</p>
        </div>
        <div class="info-card">
            <i class="bi bi-clipboard-check"></i>
            <h3 id="intro-type">MCQ</h3>
            <p>Question Type</p>
        </div>
    </div>

    <div class="instructions-section">
        <h3><i class="bi bi-info-circle"></i> Instructions</h3>
        <ul id="intro-instructions">
            <li>Read each question carefully before selecting your answer</li>
            <li>You can navigate between questions using the Previous and Next buttons</li>
            <li>Your answers will be auto-saved every 30 seconds</li>
            <li>Make sure to submit your quiz before the timer runs out</li>
            <li>Once submitted, you cannot change your answers</li>
        </ul>
    </div>

    <button id="btn-start" class="btn-start-quiz-intro" onclick="startQuizFromIntro()">
        <i class="bi bi-play-circle-fill"></i>
        Start Quiz
    </button>
</div>

<!-- ===========================
     SECTION 2: LOADING
=========================== -->
<div id="quiz-loading" class="section-hidden">
    <div class="loading-spinner"></div>
    <div class="loading-text">Loading quiz questions...</div>
</div>

<!-- ===========================
     SECTION 3: QUIZ CONTAINER
=========================== -->
<div id="quiz-container" class="section-hidden">
    <!-- Quiz Header with Timer -->
    <div class="quiz-header">
        <div class="quiz-progress">
            <span class="question-counter" id="question-counter">Question 1 of 10</span>
            <div class="auto-save-indicator" id="auto-save-indicator" style="display: none;">
                <i class="bi bi-cloud-check-fill"></i>
                <span>Saved</span>
            </div>
        </div>
        <div class="timer-display" id="timer-display">
            <i class="bi bi-clock-fill"></i>
            <span id="timer-text">30:00</span>
        </div>
    </div>

    <!-- Question Card -->
    <div class="question-card">
        <div class="question-header">
            <span class="question-number" id="current-question-number">Question 1</span>
            <span class="question-type" id="current-question-type">Multiple Choice</span>
        </div>

        <div class="question-text" id="question-text">
            Question text will appear here
        </div>

        <div class="options-container" id="options-container">
            <!-- Options will be dynamically generated -->
        </div>

        <div class="practice-feedback" id="practice-feedback">
            <h4 id="feedback-title">Feedback Title</h4>
            <p id="feedback-text">Feedback text</p>
        </div>

        <div class="quiz-navigation">
            <button class="btn-nav btn-previous" id="btn-previous" onclick="previousQuestion()">
                <i class="bi bi-arrow-left"></i>
                Previous
            </button>

            <button class="btn-nav btn-check-answer" id="btn-check-answer" onclick="checkAnswer()" style="display: none;">
                <i class="bi bi-check-circle"></i>
                Check Answer
            </button>

            <button class="btn-nav btn-next" id="btn-next" onclick="nextQuestion()">
                Next
                <i class="bi bi-arrow-right"></i>
            </button>

            <button class="btn-nav btn-submit" id="btn-submit" onclick="submitQuiz()" style="display: none;">
                <i class="bi bi-send-fill"></i>
                Submit Quiz
            </button>
        </div>
    </div>

    <!-- Question Palette -->
    <div class="question-palette">
        <div class="palette-header">
            <i class="bi bi-grid-3x3-gap"></i>
            Question Navigator
        </div>
        <div class="palette-grid" id="palette-grid">
            <!-- Palette items will be dynamically generated -->
        </div>
        <div class="palette-legend">
            <div class="legend-item">
                <div class="legend-box"></div>
                <span>Not Answered</span>
            </div>
            <div class="legend-item">
                <div class="legend-box answered"></div>
                <span>Answered</span>
            </div>
            <div class="legend-item">
                <div class="legend-box current"></div>
                <span>Current</span>
            </div>
        </div>
    </div>
</div>

<script>
// ===========================
// MOCK DATA: Quiz Data
// ===========================
const quizData = {
    info: {
        id: 1,
        title: "Mathematics Midterm Exam",
        subject: "Mathematics",
        timeLimit: 30, // minutes
        type: "exam", // or "practice"
        instructions: [
            "Read each question carefully before selecting your answer",
            "You can navigate between questions using the Previous and Next buttons",
            "Your answers will be auto-saved every 30 seconds",
            "Make sure to submit your quiz before the timer runs out",
            "Once submitted, you cannot change your answers"
        ]
    },
    questions: [
        {
            id: 1,
            text: "What is the derivative of xÂ² with respect to x?",
            type: "mcq",
            options: ["x", "2x", "xÂ²", "2xÂ²"],
            correctAnswer: 1
        },
        {
            id: 2,
            text: "What is the value of Ï€ (pi) approximately?",
            type: "mcq",
            options: ["3.14", "2.71", "1.41", "1.73"],
            correctAnswer: 0
        },
        {
            id: 3,
            text: "What is the square root of 144?",
            type: "mcq",
            options: ["10", "11", "12", "13"],
            correctAnswer: 2
        },
        {
            id: 4,
            text: "What is 15% of 200?",
            type: "mcq",
            options: ["25", "30", "35", "40"],
            correctAnswer: 1
        },
        {
            id: 5,
            text: "What is the sum of angles in a triangle?",
            type: "mcq",
            options: ["90Â°", "180Â°", "270Â°", "360Â°"],
            correctAnswer: 1
        },
        {
            id: 6,
            text: "What is 7 Ã— 8?",
            type: "mcq",
            options: ["54", "56", "58", "60"],
            correctAnswer: 1
        },
        {
            id: 7,
            text: "What is the formula for the area of a circle?",
            type: "mcq",
            options: ["Ï€r", "Ï€rÂ²", "2Ï€r", "Ï€d"],
            correctAnswer: 1
        },
        {
            id: 8,
            text: "What is the value of 2Â³?",
            type: "mcq",
            options: ["6", "8", "9", "16"],
            correctAnswer: 1
        },
        {
            id: 9,
            text: "What is 100 - 37?",
            type: "mcq",
            options: ["63", "64", "73", "74"],
            correctAnswer: 0
        },
        {
            id: 10,
            text: "What is the perimeter of a square with side length 5?",
            type: "mcq",
            options: ["15", "20", "25", "30"],
            correctAnswer: 1
        }
    ]
};

// ===========================
// GLOBAL STATE
// ===========================
let currentQuestionIndex = 0;
let userAnswers = {}; // { questionId: selectedOptionIndex }
let timerInterval = null;
let autoSaveInterval = null;
let timeRemaining = 0; // in seconds
let isPracticeMode = false;
let questionChecked = false;

// ===========================
// INITIALIZE QUIZ FROM SESSION
// ===========================
function initializeQuizData() {
    const storedQuiz = sessionStorage.getItem('currentQuiz');
    if (storedQuiz) {
        const quizInfo = JSON.parse(storedQuiz);
        quizData.info.title = quizInfo.title;
        quizData.info.subject = quizInfo.subject;
        quizData.info.timeLimit = quizInfo.duration;
        quizData.info.type = quizInfo.type;
    }

    const urlParams = new URLSearchParams(window.location.search);
    const quizType = urlParams.get('type');
    if (quizType === 'practice') {
        isPracticeMode = true;
        quizData.info.type = 'practice';
    }
}

// ===========================
// SECTION 1: INTRO PAGE
// ===========================
function populateIntroPage() {
    document.getElementById('intro-title').textContent = quizData.info.title;
    document.getElementById('intro-duration').textContent = quizData.info.timeLimit;
    document.getElementById('intro-questions').textContent = quizData.questions.length;

    const badge = document.getElementById('intro-badge');
    if (quizData.info.type === 'exam') {
        badge.textContent = 'ðŸ“ Graded Exam';
        badge.classList.add('exam');
        document.getElementById('btn-start').classList.remove('btn-start-practice');
        document.getElementById('btn-start').classList.add('btn-start-exam');
    } else {
        badge.textContent = 'âœï¸ Practice Mode';
        badge.classList.add('practice');
        document.getElementById('btn-start').classList.remove('btn-start-exam');
        document.getElementById('btn-start').classList.add('btn-start-practice');
    }

    const instructionsList = document.getElementById('intro-instructions');
    instructionsList.innerHTML = quizData.info.instructions.map(instruction =>
        `<li>${instruction}</li>`
    ).join('');
}

function startQuizFromIntro() {
    // Hide intro
    document.getElementById('quiz-intro').classList.remove('section-visible');
    document.getElementById('quiz-intro').classList.add('section-hidden');

    // Show loading
    document.getElementById('quiz-loading').classList.remove('section-hidden');
    document.getElementById('quiz-loading').classList.add('section-visible');

    // Simulate loading delay
    setTimeout(() => {
        document.getElementById('quiz-loading').classList.remove('section-visible');
        document.getElementById('quiz-loading').classList.add('section-hidden');

        // Show quiz container
        document.getElementById('quiz-container').classList.remove('section-hidden');
        document.getElementById('quiz-container').classList.add('section-visible');

        // Initialize quiz
        initializeQuiz();
    }, 1500);
}

// ===========================
// SECTION 3: QUIZ LOGIC
// ===========================
function initializeQuiz() {
    // Initialize timer
    timeRemaining = quizData.info.timeLimit * 60; // Convert to seconds
    startTimer();

    // Start auto-save
    startAutoSave();

    // Render question palette
    renderQuestionPalette();

    // Show first question
    renderQuestion();

    // Show/hide practice mode button
    if (isPracticeMode) {
        document.getElementById('btn-check-answer').style.display = 'flex';
    }
}

// ===========================
// TIMER LOGIC
// ===========================
function startTimer() {
    updateTimerDisplay();

    timerInterval = setInterval(() => {
        timeRemaining--;
        updateTimerDisplay();

        // Warning when 5 minutes left
        if (timeRemaining <= 300) {
            document.getElementById('timer-display').classList.add('warning');
        }

        // Auto-submit when time runs out
        if (timeRemaining <= 0) {
            clearInterval(timerInterval);
            alert('Time is up! Your quiz will be submitted automatically.');
            submitQuiz();
        }
    }, 1000);
}

function updateTimerDisplay() {
    const minutes = Math.floor(timeRemaining / 60);
    const seconds = timeRemaining % 60;
    const timerText = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    document.getElementById('timer-text').textContent = timerText;
}

// ===========================
// AUTO-SAVE LOGIC
// ===========================
function startAutoSave() {
    autoSaveInterval = setInterval(() => {
        autoSaveAnswers();
    }, 30000); // Every 30 seconds
}

function autoSaveAnswers() {
    console.log('Auto-saving answers to backend...', userAnswers);

    // Show auto-save indicator
    const indicator = document.getElementById('auto-save-indicator');
    indicator.style.display = 'flex';

    // Hide after 2 seconds
    setTimeout(() => {
        indicator.style.display = 'none';
    }, 2000);

    // In a real app, you would make an API call here:
    // fetch('/api/save-answers', { method: 'POST', body: JSON.stringify(userAnswers) })
}

// ===========================
// RENDER QUESTION
// ===========================
function renderQuestion() {
    const question = quizData.questions[currentQuestionIndex];
    questionChecked = false;

    // Update counter
    document.getElementById('question-counter').textContent =
        `Question ${currentQuestionIndex + 1} of ${quizData.questions.length}`;

    // Update question number
    document.getElementById('current-question-number').textContent =
        `Question ${currentQuestionIndex + 1}`;

    // Update question text
    document.getElementById('question-text').textContent = question.text;

    // Render options
    const optionsContainer = document.getElementById('options-container');
    optionsContainer.innerHTML = question.options.map((option, index) => {
        const isSelected = userAnswers[question.id] === index;
        return `
            <div class="option-item ${isSelected ? 'selected' : ''}" onclick="selectOption(${index})">
                <div class="option-radio"></div>
                <div class="option-text">${option}</div>
            </div>
        `;
    }).join('');

    // Hide feedback
    document.getElementById('practice-feedback').style.display = 'none';
    document.getElementById('practice-feedback').classList.remove('correct', 'incorrect');

    // Update navigation buttons
    updateNavigationButtons();

    // Update palette
    updatePaletteHighlight();
}

// ===========================
// SELECT OPTION
// ===========================
function selectOption(optionIndex) {
    if (questionChecked) return; // Don't allow changing after checking in practice mode

    const question = quizData.questions[currentQuestionIndex];
    userAnswers[question.id] = optionIndex;

    // Update UI
    document.querySelectorAll('.option-item').forEach((item, index) => {
        if (index === optionIndex) {
            item.classList.add('selected');
        } else {
            item.classList.remove('selected');
        }
    });

    // Update palette
    updatePaletteHighlight();
}

// ===========================
// CHECK ANSWER (PRACTICE MODE)
// ===========================
function checkAnswer() {
    const question = quizData.questions[currentQuestionIndex];
    const selectedAnswer = userAnswers[question.id];

    if (selectedAnswer === undefined) {
        alert('Please select an answer first!');
        return;
    }

    questionChecked = true;
    const isCorrect = selectedAnswer === question.correctAnswer;

    // Highlight options
    document.querySelectorAll('.option-item').forEach((item, index) => {
        if (index === question.correctAnswer) {
            item.classList.add('correct');
        }
        if (index === selectedAnswer && !isCorrect) {
            item.classList.add('incorrect');
        }
    });

    // Show feedback
    const feedback = document.getElementById('practice-feedback');
    const feedbackTitle = document.getElementById('feedback-title');
    const feedbackText = document.getElementById('feedback-text');

    if (isCorrect) {
        feedback.classList.add('correct');
        feedbackTitle.textContent = 'âœ“ Correct!';
        feedbackText.textContent = 'Great job! Your answer is correct.';
    } else {
        feedback.classList.add('incorrect');
        feedbackTitle.textContent = 'âœ— Incorrect';
        feedbackText.textContent = `The correct answer is: ${question.options[question.correctAnswer]}`;
    }

    feedback.style.display = 'block';
}

// ===========================
// NAVIGATION
// ===========================
function previousQuestion() {
    if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        renderQuestion();
    }
}

function nextQuestion() {
    if (currentQuestionIndex < quizData.questions.length - 1) {
        currentQuestionIndex++;
        renderQuestion();
    }
}

function updateNavigationButtons() {
    const btnPrevious = document.getElementById('btn-previous');
    const btnNext = document.getElementById('btn-next');
    const btnSubmit = document.getElementById('btn-submit');

    // Previous button
    btnPrevious.disabled = currentQuestionIndex === 0;

    // Next/Submit button
    if (currentQuestionIndex === quizData.questions.length - 1) {
        btnNext.style.display = 'none';
        btnSubmit.style.display = 'flex';
    } else {
        btnNext.style.display = 'flex';
        btnSubmit.style.display = 'none';
    }
}

// ===========================
// QUESTION PALETTE
// ===========================
function renderQuestionPalette() {
    const paletteGrid = document.getElementById('palette-grid');
    paletteGrid.innerHTML = quizData.questions.map((question, index) => {
        return `
            <div class="palette-item" onclick="jumpToQuestion(${index})">
                ${index + 1}
            </div>
        `;
    }).join('');
}

function updatePaletteHighlight() {
    document.querySelectorAll('.palette-item').forEach((item, index) => {
        item.classList.remove('current', 'answered');

        if (index === currentQuestionIndex) {
            item.classList.add('current');
        } else if (userAnswers[quizData.questions[index].id] !== undefined) {
            item.classList.add('answered');
        }
    });
}

function jumpToQuestion(index) {
    currentQuestionIndex = index;
    renderQuestion();
}

// ===========================
// SUBMIT QUIZ
// ===========================
function submitQuiz() {
    // Check if all questions are answered
    const unansweredCount = quizData.questions.filter(q =>
        userAnswers[q.id] === undefined
    ).length;

    if (unansweredCount > 0) {
        const confirmSubmit = confirm(
            `You have ${unansweredCount} unanswered question(s). Do you want to submit anyway?`
        );
        if (!confirmSubmit) return;
    }

    // Stop timers
    clearInterval(timerInterval);
    clearInterval(autoSaveInterval);

    // Calculate score (for display purposes)
    let correctCount = 0;
    quizData.questions.forEach(question => {
        if (userAnswers[question.id] === question.correctAnswer) {
            correctCount++;
        }
    });

    const score = ((correctCount / quizData.questions.length) * 100).toFixed(2);

    console.log('Quiz submitted!');
    console.log('User Answers:', userAnswers);
    console.log('Score:', score + '%');

    // In a real app, you would send data to backend:
    // fetch('/api/submit-quiz', { method: 'POST', body: JSON.stringify({ answers: userAnswers }) })

    alert(`Quiz submitted successfully!\n\nYour Score: ${score}%\nCorrect Answers: ${correctCount}/${quizData.questions.length}`);

    // Redirect to dashboard or results page
    window.location.href = '/student_dashboard';
}

// ===========================
// PREVENT ACCIDENTAL NAVIGATION
// ===========================
window.addEventListener('beforeunload', function (e) {
    if (document.getElementById('quiz-container').classList.contains('section-visible')) {
        e.preventDefault();
        e.returnValue = 'You have an active quiz. Are you sure you want to leave?';
    }
});

// ===========================
// INITIALIZE ON PAGE LOAD
// ===========================
document.addEventListener('DOMContentLoaded', function() {
    initializeQuizData();
    populateIntroPage();
});
</script>

{% endblock %}
