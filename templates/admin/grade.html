{% extends "admin/admin_base.html" %}

{% block title %}Manage Grades{% endblock %}
{% block header_title %}Grade Management{% endblock %}

{% block content %}

<!-- TOP FILTERS -->
<div class="d-flex justify-content-end mb-4 gap-3">
    <select id="teacherFilter" class="form-select filter-select">
        <option value="">Filter by Teacher</option>
        {% for t in teachers %}
        <option value="{{ t.full_name }}">{{ t.full_name }}</option>
        {% endfor %}
    </select>

    <select id="yearFilter" class="form-select filter-select">
        <option value="">Filter by Year</option>
        {% for y in years %}
        <option value="{{ y.academic_year }}">{{ y.academic_year }}</option>
        {% endfor %}
    </select>
</div>

<div class="grade-board">

    {% for grade, class_list in grades.items() %}
    <div class="grade-column" data-grade="{{ grade }}">

        <div class="grade-header-full mb-2">
            <h5 class="column-title m-0 text-center w-100">Grade {{ grade }}</h5>
        </div>

        <!-- Class Filter -->
        <div class="d-flex justify-content-end mb-3">
            <select class="form-select class-filter classFilter" data-grade="{{ grade }}">
                <option value="">Class: All</option>
                {% for cls in class_list %}
                <option value="{{ cls.class_name }}">{{ cls.class_name }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- CLASS LIST -->
        {% for cls in class_list %}
        <div class="grade-card class-box"
             data-teacher="{{ cls.teacher_names }}"
             data-year="{{ cls.academic_year }}"
             data-class="{{ cls.class_name }}">

            <div class="card-header-line"></div>

            <h6 class="fw-bold mb-2">Class {{ cls.class_name }}</h6>
            <p><b>Students:</b> {{ cls.student_count }}</p>

            <p><b>Teacher:</b>
                {% if cls.teacher_names %}
                    {{ cls.teacher_names }}
                {% else %}
                    <span class="text-danger">No Teacher Assigned</span>
                {% endif %}
            </p>

            <p><b>Status:</b>
                {% if cls.teacher_names %}
                    <span class="text-success fw-bold">Active</span>
                {% else %}
                    <span class="text-warning fw-bold">Pending</span>
                {% endif %}
            </p>

            <p><b>Upcoming Test:</b>
                {% if cls.next_test_date %}
                    {{ cls.next_test_date }}
                {% else %}
                    Not Scheduled
                {% endif %}
            </p>

            <!-- SUBJECTS (ONLY TEACHER SUBJECTS) -->
            <div class="subject-box mt-3">
                <p class="fw-bold mb-2 text-center">Subjects</p>

                <div class="subject-tags justify-content-center">

                    {% if cls.teacher_subjects %}
                        {% for sub in cls.teacher_subjects %}
                        <span class="subject-pill subject-yellow">{{ sub }}</span>
                        {% endfor %}
                    {% else %}
                        <span class="text-muted">No subjects assigned</span>
                    {% endif %}

                </div>
            </div>

            <!-- BUTTONS -->
            <div class="d-flex justify-content-center gap-2 mt-3">
                <a href="{{ url_for('admin_results', class_id=cls.class_id) }}" class="btn result-btn">Result</a>

                <a href="{{ url_for('admin_assign_test', class_id=cls.class_id) }}" class="assign-btn text-center">Exam</a>
            </div>

        </div>
        {% endfor %}

        <!-- ADD BUTTON -->
        <button class="add-card-btn"
                onclick="window.location.href='{{ url_for('admin_add_class', from_grade=1) }}'">
            +
        </button>

    </div>
    {% endfor %}
</div>
<style>
.filter-select {
    width: 170px;
    border-radius: 10px;
}

.grade-board {
    display: flex;
    justify-content: center;
    gap: 25px;
    flex-wrap: wrap;
}

.grade-column {
    background: #f7f9ff;
    padding: 20px;
    border-radius: 14px;

    width: 380px;
    min-width: 380px;
    max-width: 380px;
}

.class-filter {
    width: 110px;
    border-radius: 8px;
    font-size: 14px;
}

.grade-card {
    background: white;
    padding: 22px;
    border-radius: 12px;
    border: 3px solid #0097e6 !important;
    margin-bottom: 18px;

    width: 100%;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
}

/* Subject box */
.subject-box {
    background: #f1f5ff;
    padding: 12px;
    border-radius: 12px;

    min-height: 70px;
    max-height: 120px;
    overflow-y: auto;
}

.card-header-line {
    width: 60px;
    height: 4px;
    background: #0097e6;
    border-radius: 10px;
    margin-bottom: 10px;
}

.assign-btn {
    background: #0097e6;
    color: white;
    padding: 10px 30px;
    border-radius: 10px;
    font-weight: 600;
    text-decoration: none !important;
}

.assign-btn:hover {
    background: #007cc2 !important;  
    color: white !important;
    text-decoration: none !important;
}

.result-btn {
    background: #f39c12;
    color: white;
    padding: 10px 30px;
    font-weight: 600;
    border-radius: 10px;
    text-decoration: none !important;
}

.result-btn:hover {
    background: #cf7d01 !important;  
    color: white !important;
    text-decoration: none !important;
}

.add-card-btn {
    background: #dbeafe;
    border: none;
    width: 100%;
    padding: 16px 0;
    border-radius: 12px;
    font-size: 28px;
    font-weight: bold;
}

.subject-pill {
    padding: 2px 5px;
    background: #fff7a3;
    border-radius: 10px;
    font-weight: 700;
}
</style>

<script>
// ---------------------- TEACHER + YEAR FILTER ----------------------
document.getElementById("teacherFilter").addEventListener("change", filterAll);
document.getElementById("yearFilter").addEventListener("change", filterAll);

function filterAll() {
    let selectedTeacher = document.getElementById("teacherFilter").value;
    let selectedYear = document.getElementById("yearFilter").value;

    document.querySelectorAll(".class-box").forEach(card => {
        let matchTeacher = (!selectedTeacher || selectedTeacher === card.dataset.teacher);
        let matchYear = (!selectedYear || selectedYear === card.dataset.year);

        card.style.display = (matchTeacher && matchYear) ? "block" : "none";
    });
}

// ---------------------- CLASS FILTER ----------------------
document.querySelectorAll(".classFilter").forEach(filter => {
    filter.addEventListener("change", function () {
        let grade = this.dataset.grade;
        let selectedClass = this.value;

        document
            .querySelectorAll(`.grade-column[data-grade="${grade}"] .class-box`)
            .forEach(card => {
                let match = (!selectedClass || selectedClass === card.dataset.class);
                card.style.display = match ? "block" : "none";
            });
    });
});
</script>

{% endblock %}
