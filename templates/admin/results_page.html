{% extends "admin/admin_base.html" %}

{% block title %}Test Results - Grade {{ grade }} {{ class_name }}{% endblock %}
{% block header_title %}Results for Grade {{ grade }} - Class {{ class_name }}{% endblock %}

{% block content %}

<!-- BACK BUTTON -->
<div class="mb-3">
    <a href="{{ url_for('admin_manage_grades') }}"
       class="btn btn-sm d-inline-flex align-items-center rounded-pill px-3 py-1"
       style="background:#2d3e50; color:white;">
        <i class="bi bi-arrow-left-circle me-1"></i> Back
    </a>
</div>

<!-- SUBJECT FILTER ONLY -->
<div class="mb-4 d-flex justify-content-end">
    <select id="subjectFilter" class="form-select filter-input" style="margin-right: 50px;">
        <option value="all">All Subjects</option>
        {% for s in subjects %}
            <option value="{{ s.subject_name|lower }}">{{ s.subject_name }}</option>
        {% endfor %}
    </select>
</div>

<!-- RESULTS CARD -->
<div class="results-wrapper">
    <div class="results-card">

        <h2 class="text-center fw-bold mb-2">Test Results</h2>
        <p class="text-center mb-1">
            <b>Grade:</b> {{ grade }} &nbsp; | &nbsp; <b>Class:</b> {{ class_name }}
        </p>

        <hr>

        <table class="table table-bordered text-center align-middle" id="resultsTable">
            <thead class="results-header">
                <tr>
                    <th>#</th>
                    <th>Student ID</th>
                    <th>Student Name</th>
                    <th>Quiz 10%</th>
                    <th>Assignment 20%</th>
                    <th>Midterm 30%</th>
                    <th>Final 40%</th>
                    <th>Total</th>
                    <th>Grade</th>
                    <th>Teacher</th>
                    <th>Subject</th>
                </tr>
            </thead>
            <tbody>

                {% if results|length == 0 %}
                <tr>
                    <td colspan="11" class="py-4" style="color:#777; font-size:18px;">
                        No test results available for this class yet.
                    </td>
                </tr>

                {% else %}
                {% for r in results %}
                <tr 
                    data-subject="{{ r.subject_name|lower }}"
                >
                    <td>{{ loop.index }}</td>
                    <td>STU-{{ "%03d"|format(r.student_id) }}</td>
                    <td>{{ r.student_name }}</td>

                    <td>{{ r.quiz_score }}</td>
                    <td>{{ r.assignment_score }}</td>
                    <td>{{ r.midterm_score }}</td>
                    <td>{{ r.final_score }}</td>

                    <td><b>{{ r.total_score }}%</b></td>
                    <td>{{ r.grade }}</td>
                    <td>{{ r.teacher_name }}</td>
                    <td>{{ r.subject_name }}</td>
                </tr>
                {% endfor %}
                {% endif %}
            </tbody>
        </table>

    </div>
</div>

<!-- CSS -->
<style>
.filter-input {
    width: 180px;
    border-radius: 8px;
}

.results-wrapper {
    display: flex;
    justify-content: center;
}

.results-card {
    background: white;
    width: 92%;
    padding: 28px;
    border-radius: 16px;
    box-shadow: 0 4px 14px rgba(0,0,0,0.10);
}

.results-header th {
    background: #2c3e50;
    color: white;
    font-weight: 700;
    padding: 12px;
}
</style>

<!-- SUBJECT FILTER SCRIPT ONLY -->
<script>
document.getElementById("subjectFilter").addEventListener("change", function () {
    const subject = this.value;
    const rows = document.querySelectorAll("#resultsTable tbody tr");

    rows.forEach(row => {
        if (row.querySelector("td")?.colSpan === 11) return;

        const rowSubject = row.dataset.subject;
        row.style.display = (subject === "all" || subject === rowSubject) ? "" : "none";
    });
});
</script>

{% endblock %}
