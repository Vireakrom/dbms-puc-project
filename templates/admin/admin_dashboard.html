{% extends "admin/admin_base.html" %}

{% block title %}Admin Dashboard{% endblock %}
{% block header_title %}Admin Dashboard{% endblock %}

{% block content %}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


<script src="https://unpkg.com/feather-icons"></script>

<style>
body { background: #f4f6fb; }

.dashboard-cards {
    display: flex;
    justify-content: space-between;
    gap: 20px;
    flex-wrap: nowrap;
}

.stat-card {
    background:white;
    padding: 30px;
    border-radius: 18px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    transition: 0.2s;
    cursor: pointer;
    flex: 1;
    height: 130px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
    min-width: 150px;
}
.stat-card:hover { transform: translateY(-6px); }

.stat-title {
    font-size: 15px;
    color: #777;
    font-weight: 600;
    margin-bottom: 12px;
}

.stat-body {
    display: flex;
    gap: 15px;
    margin-top: 0;
    justify-content: center;
    align-items: center;
}

.stat-icon-circle {
    width: 55px;
    height: 55px;
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 26px;
    color: white;
}

.stat-number {
    font-size: 30px;
    font-weight: 700;
    color: #1e293b;
}

.notification-card {
    background: #fff;
    padding: 15px;
    border-radius: 15px;
    box-shadow: 0px 4px 12px rgba(0,0,0,0.06);
    margin-top: -14px;
    min-height: 420px;
}

.notif-time {
    width: 75px;
    font-weight: 900;
}
.notif-time.blue { color: #0d47a1; }
.notif-time.green { color: #0a5c34; }
.notif-time.cyan { color: #0277bd; }
.notif-time.orange { color: #e65100; }
.notif-time.red { color: #b71c1c; }

.notif-line {
    width: 4px;
    height: 35px;
    margin-right: 10px;
    border-radius: 3px;
}


.result-card {
    background: #fff;
    padding: 25px;
    border-radius: 18px;
    box-shadow: 0px 4px 12px rgba(0,0,0,0.06);
    margin-top: -18px !important;
    min-height: 450px;
}

.result-divider {
    width: 60px;
    height: 3px;
    background: #3b82f6;
    margin: 8px auto 18px auto;
    border-radius: 4px;
}

.filter-select {
    padding: 6px 16px;
    padding-right: 2.5rem;
    border: 1px solid #d1d5db;
    border-radius: 10px;
    background-color: #f9fafb;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 0.75rem center;
    background-size: 16px 12px;
    font-size: 14px;
    cursor: pointer;
    appearance: none;
}
.filter-select:hover { border-color: #3b82f6; }

.result-chart-box {
    background: #f8faff;
    padding: 25px;
    border-radius: 16px;
    margin-top: 12px;
}

.result-inner {
    display: flex;
    justify-content: space-evenly;
    align-items: center;
}

.donut-wrapper {
    display: flex;
    justify-content: center;
    align-items: center;
}

.result-info-panel {
    background:white;
    padding:20px 25px;
    border-radius:20px;
    margin-left:20px;
    box-shadow:0 2px 10px rgba(0,0,0,0.05);
    min-width: 350px;  
}


.outer-exam-wrapper {
    background: white;
    padding: 25px;
    border-radius: 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    margin-top: 25px;
}

.exam-top-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.nav-btn {
    background: white;
    border: 1px solid #d1d5db;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: inline-flex;
    justify-content: center;
    align-items: center;
    font-size: 18px;
    cursor: pointer;
    transition: .2s;
}
.nav-btn:hover { background: #f1f5f9; }

.inner-dark-wrap {
    background: #F8FAFF;
    padding: 25px;
    border-radius: 16px;
}

.exam-scroll-container {
    display: flex;
    gap: 22px;
    overflow-x: auto;
    overflow-y: hidden;
    white-space: nowrap;
    width: 100%;
    padding-bottom: 10px;
    scroll-behavior: smooth;
    -webkit-overflow-scrolling: touch;
}

.exam-scroll-container::-webkit-scrollbar {
    height: 10px;
}
.exam-scroll-container::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 10px;
}
.exam-scroll-container::-webkit-scrollbar-track {
    background: #e2e8f0;
}

/* CARD */
.exam-box {
    background: #ffffff;
    width: 265px;
    padding: 23px;
    border-radius: 18px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.06);
    flex-shrink: 0;
    white-space: normal;
    position: relative;
}

.exam-icon {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: #e7efff;
    display: flex;
    justify-content: center;
    align-items: center;
}

.progress-horizontal {
    width: 100%;
    height: 10px;
    background: #e5e7eb;
    border-radius: 12px;
    margin-top: 20px;
}

.progress-fill {
    height: 100%;
    background: #22c55e;
    border-radius: 12px;
}

.exam-bottom {
    margin-top: 10px;
    color: #475569;
    font-size: 14px;
}

.exam-subject-tag {
    position: absolute;
    top: 15px;
    right: 15px;
    background: #fff7a6;
    padding: 4px 12px;
    font-weight: 700;
    font-size: 15px;
    border-radius: 8px;
    color: #5c4a00;
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    z-index: 10;
}

#examScroll {
    width: 100%;
    max-width: 100%;
    overflow-x: auto !important;
    display: flex;
}

.exam-box {
    flex: 0 0 265px !important;
    max-width: 265px !important;
}

.section-title {
    font-size: 20px !important;
    font-weight: 700 !important;
    margin-bottom: 10px;
    margin-top: 5px;
}

.overview-cards {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
    margin-bottom: 25px;
}

.overview-card {
    flex: 1;
    min-width: 220px;
    background: #ffffff;
    padding: 22px;
    border-radius: 16px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.07);
    transition: .2s;
}

.overview-card:hover {
    transform: translateY(-5px);
}

.overview-title {
    font-size: 14px;
    color: #6c757d;
    font-weight: 600;
}

.overview-value {
    margin-top: 10px;
    font-size: 26px;
    font-weight: 700;
    color: #1e293b;
}

.overview-icon {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    color:white;
    margin-left: auto;
}
#resultChart {
    max-width: 260px !important;
    max-height: 260px !important;
}
.donut-wrapper {
    min-width: 260px;
    min-height: 260px;
    display: flex;
    justify-content: center;
    align-items: center;
}

.exam-info-text,
.exam-info-text * {
    font-size: 17px !important;
    line-height: 1.35 !important;
    color: #374151 !important;
    font-weight: 400 !important;
    margin-bottom: 8px !important;
}

.exam-teacher {
    font-size: 17px !important;
    font-weight: 400 !important;
}


.exam-bottom {
    font-size: 15px !important;
    font-weight: 400 !important;
    color: #374151 !important;
    margin-top: 10px;
}

.exam-bottom i {
    font-size: 18px !important;
    margin-right: 6px;
}

.exam-status-big {
    font-size: 20px !important;
    font-weight: 700 !important;
    margin-top: -5px;  
    margin: 0 !important;        
 
}
.exam-title {
    text-align: center !important;
    margin-bottom: 12px !important;
    width: 100%;
}
.exam-header-center {
    text-align: center;
    margin-bottom: 14px;
}

</style>

<!-- =================== DASHBOARD OVERVIEW CARDS =================== -->
<div class="dashboard-cards">

    <!-- STUDENTS -->
   <a href="{{ url_for('admin_total_students', from_dashboard=1) }}" class="text-decoration-none text-dark w-100">

        <div class="stat-card">
            <span class="stat-title">Total Students</span>
            <div class="stat-body">
                <div class="stat-number">{{ total_students }}</div>
                <div class="stat-icon-circle" style="background:#1565C0;">
                    <i class="bi bi-people-fill"></i>
                </div>
            </div>
        </div>
    </a>

    <!-- TEACHERS -->
    <a href="{{ url_for('admin_total_teachers', from_dashboard=1) }}" class="text-decoration-none text-dark w-100">
        <div class="stat-card">
            <span class="stat-title">Total Teachers</span>
            <div class="stat-body">
                <div class="stat-number">{{ total_teachers }}</div>
                <div class="stat-icon-circle" style="background:#009688;">
                    <i class="bi bi-person-workspace"></i>
                </div>
            </div>
        </div>
    </a>

    <!-- CLASSES -->
    <a href="{{ url_for('admin_add_class', from_dashboard=1) }}" class="text-decoration-none text-dark w-100">
        <div class="stat-card">
            <span class="stat-title">Total Classes</span>
            <div class="stat-body">
                <div class="stat-number">{{ total_classes }}</div>
                <div class="stat-icon-circle" style="background:#f39c12;">
                    <i class="bi bi-door-open-fill"></i>
                </div>
            </div>
        </div>
    </a>

    <!-- SUBJECTS -->
    <a href="{{ url_for('admin_add_subject', from_dashboard=1) }}" class="text-decoration-none text-dark w-100">
        <div class="stat-card">
            <span class="stat-title">Total Subjects</span>
            <div class="stat-body">
                <div class="stat-number">{{ total_subjects }}</div>
                <div class="stat-icon-circle" style="background:#8e44ad;">
                    <i class="bi bi-journal-bookmark-fill"></i>
                </div>
            </div>
        </div>
    </a>

    <!-- REPORTS -->
    <a href="{{ url_for('admin_report', from_dashboard=1) }}" class="text-decoration-none text-dark w-100">
        <div class="stat-card">
            <span class="stat-title">Reports</span>
            <div class="stat-body">
                <div class="stat-icon-circle" style="background:#e74c3c;">
                    <i class="bi bi-flag-fill"></i>
                </div>
            </div>
        </div>
    </a>

</div>


<!-- ================= NOTIFICATION + RESULT OVERVIEW ================= -->

<div class="row g-4 align-items-stretch mt-3">

    <!-- LEFT: NOTIFICATIONS -->
    <div class="col-md-4 d-flex">
        <div class="notification-card flex-fill">
            <h3 class="section-title">Recent Notifications</h3>

            <ul class="list-unstyled mt-3">

                {% set colors = ['blue', 'green', 'cyan', 'orange', 'red'] %}
                {% set line_colors = ['#1e88e5','#2ecc71','#00bcd4','#ff7043','#e57373'] %}

                {# SHOW NEWEST FIRST #}
                {% for log in notifications|reverse %}
                <li class="mb-3 d-flex">

                    <!-- TIME COLOR -->
                    <div class="notif-time {{ colors[loop.index0 % 5] }}">
                        {{ log.timestamp.strftime("%H:%M") }}
                    </div>

                    <!-- VERTICAL LINE -->
                    <div class="notif-line"
                        style="background: {{ line_colors[loop.index0 % 5] }};">
                    </div>

                    <!-- MESSAGE -->
                    <div>
                        {{ log.action }}.<br>
                        <small>by {{ log.user_name }}</small>

                    </div>

                </li>
                {% endfor %}

                {% if notifications|length == 0 %}
                    <li class="text-muted mt-2">No recent notifications.</li>
                {% endif %}

            </ul>
        </div>
    </div>

 <!-- RIGHT: RESULT OVERVIEW -->
<div class="col-md-8 d-flex">
    <div class="result-card flex-fill">

        <h3 class="section-title text-center">Result Overview</h3>
        <div class="result-divider"></div>

        <!-- FILTERS -->
        <div class="result-filters d-flex flex-wrap justify-content-center gap-3 mb-3">

            <!-- GRADE FILTER -->
            <select class="filter-select" id="gradeFilter">
                <option value="">Filter by Grade</option>
                {% for g in grades %}
                    <option value="{{ g.grade_level }}">Grade {{ g.grade_level }}</option>
                {% endfor %}
            </select>

            <!-- TEACHER FILTER -->
            <select class="filter-select" id="teacherFilter">
                <option value="">Filter by Teacher</option>
            </select>

            <!-- YEAR FILTER -->
            <select class="filter-select" id="yearFilter">
                <option value="">Year</option>
                {% for y in years %}
                    <option value="{{ y.academic_year }}">{{ y.academic_year }}</option>
                {% endfor %}
            </select>

            <!-- RESULT TYPE FILTER -->
            <select class="filter-select" id="resultTypeFilter">
                <option value="">Result Type</option>
                <option value="top">Top Result</option>
                <option value="average">Average</option>
                <option value="fail">Fail</option>
            </select>

        </div>

        <!-- Chart Box -->
        <div class="result-chart-box">
            <div class="result-inner d-flex" style="align-items: flex-start;">

                <!-- LEFT CHART -->
                <div class="donut-wrapper" style="flex: 0 0 260px; text-align:center;">
                    <canvas id="resultChart" width="220" height="220"></canvas>
                </div>

                <!-- RIGHT PANEL -->
                <div class="result-info-panel">
                    <h6 class="fw-bold mb-3">Performance Summary</h6>

                    <div class="mb-2"><b>Top Result:</b> <span id="topResult">{{ top_result }}</span> Students</div>
                    <div class="mb-2"><b>Average:</b> <span id="averageResult">{{ average_result }}</span> Students</div>
                    <div class="mb-2"><b>Fail:</b> <span id="failResult">{{ fail_result }}</span> Students</div>

                    <hr>

                    <p class="text-muted mb-1">Filtered Grade: <b id="selectedGrade">None</b></p>
                    <p class="text-muted mb-1">Teacher: <b id="selectedTeacher">None</b></p>
                    <p class="text-muted mb-1">Year: <b id="selectedYear">None</b></p>
                </div>

            </div>
        </div>

    </div>
    
</div>
<div class="outer-exam-wrapper">

    <div class="exam-top-bar">
        <h3 class="section-title">Exam Status Monitoring</h3>

        <div>
            <button class="nav-btn" id="leftBtn"><i class="bi bi-chevron-left"></i></button>
            <button class="nav-btn" id="rightBtn"><i class="bi bi-chevron-right"></i></button>
        </div>
    </div>

    <div class="inner-dark-wrap">
        <div class="exam-scroll-container" id="examScroll">

            {% if live_exams and live_exams|length > 0 %}
                {% for exam in live_exams %}

                {% set total_minutes = (exam.end_time - exam.start_time).seconds // 60 %}
                {% set minutes_left = exam.minutes_left if exam.minutes_left > 0 else 0 %}

                {% if exam.status == 'live' %}
                    {% if total_minutes > 0 %}
                        {% set percent_done = ((total_minutes - minutes_left) / total_minutes * 100) | round(0) %}
                    {% else %}
                        {% set percent_done = 0 %}
                    {% endif %}
                {% elif exam.status == 'finished' %}
                    {% set percent_done = 100 %}
                {% else %}
                    {% set percent_done = 0 %}
                {% endif %}

                <div class="exam-box">

                    <span class="exam-subject-tag">{{ exam.subject_name }}</span>

                    <div class="exam-icon mb-2">
                        <i class="bi bi-pencil-square" style="font-size:24px;color:#2563eb;"></i>
                    </div>

                    <div class="exam-header-center">
                        <h5 class="fw-bold exam-title">Class {{ exam.class_name }} Test</h5>

                        {% if exam.status == 'live' %}
                            <p class="exam-status-big text-success">● Live Now</p>
                        {% elif exam.status == 'upcoming' %}
                            <p class="exam-status-big text-warning">● Upcoming</p>
                        {% else %}
                            <p class="exam-status-big text-danger">● Finished</p>
                        {% endif %}
                    </div>

                    <p class="exam-info-text">
                        <i class="bi bi-journal-text"></i>
                        {{ exam.exam_type }} • {{ exam.percentage_weight }}%
                    </p>

                    <p class="exam-info-text exam-teacher">
                        <i class="bi bi-person"></i>
                        Teacher: {{ exam.teacher_name if exam.teacher_name else "Unknown" }}
                    </p>

                    <p class="exam-info-text">
                        <i class="bi bi-clock"></i>
                        {{ exam.start_time.strftime("%I:%M %p") }} – {{ exam.end_time.strftime("%I:%M %p") }}
                    </p>

                    <p class="exam-info-text">
                        <i class="bi bi-people"></i> {{ exam.total_students }} Students
                    </p>

                    <div class="progress-horizontal">
                        <div class="progress-fill" style="width: {{ percent_done }}%;"></div>
                    </div>

                    <div class="exam-bottom mt-2">
                        {% if exam.status == 'live' %}
                            <i class="bi bi-hourglass-split"></i> {{ minutes_left }} min left
                        {% elif exam.status == 'upcoming' %}
                            <i class="bi bi-calendar-event"></i> Starts soon
                        {% else %}
                            <i class="bi bi-check2-circle"></i> Exam Ended
                        {% endif %}
                    </div>

                </div>

                {% endfor %}
            {% else %}
                <p class="text-muted">No exams available.</p>
            {% endif %}

        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

    const scroller = document.getElementById("examScroll");
    const leftBtn = document.getElementById("leftBtn");
    const rightBtn = document.getElementById("rightBtn");
    const SCROLL_STEP = 320;

    function updateButtons() {
        if (!scroller) return;
        const maxScroll = scroller.scrollWidth - scroller.clientWidth;
        leftBtn.disabled = scroller.scrollLeft <= 0;
        rightBtn.disabled = scroller.scrollLeft >= maxScroll - 2;
    }

    if (scroller) {
        leftBtn.addEventListener("click", () => {
            scroller.scrollBy({ left: -SCROLL_STEP, behavior: "smooth" });
            setTimeout(updateButtons, 350);
        });

        rightBtn.addEventListener("click", () => {
            scroller.scrollBy({ left: SCROLL_STEP, behavior: "smooth" });
            setTimeout(updateButtons, 350);
        });

        scroller.addEventListener("scroll", updateButtons);
        updateButtons();
    }

    feather.replace();

    let chart = null;

    function renderChart(top, avg, fail) {
        const ctx = document.getElementById("resultChart");

        let safeTop = top;
        let safeAvg = avg;
        let safeFail = fail;

        if (top === 0 && avg === 0 && fail === 0) {
            safeTop = 1;
            safeAvg = 1;
            safeFail = 1;
        }

        if (chart) chart.destroy();

        chart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Top Result', 'Average', 'Fail'],
                datasets: [{
                    data: [safeTop, safeAvg, safeFail],
                    backgroundColor: ['#3b82f6', '#f59e0b', '#ef4444'],
                    hoverOffset: 8
                }]
            },
            options: {
                responsive: false,
                maintainAspectRatio: false,
                cutout: '60%',
                plugins: {
                    legend: { display: false },

                    tooltip: {
                        callbacks: {
                            label: function(ctx) {
                                const index = ctx.dataIndex;
                                const realValues = [top, avg, fail];
                                return `${ctx.label}: ${realValues[index]} students`;
                            }
                        }
                    }
                }
            }
        });
    }


    renderChart({{ top_result }}, {{ average_result }}, {{ fail_result }});


    const gradeFilter = document.getElementById("gradeFilter");
    const teacherFilter = document.getElementById("teacherFilter");
    const yearFilter = document.getElementById("yearFilter");
    const resultTypeFilter = document.getElementById("resultTypeFilter");

    const selectedGrade = document.getElementById("selectedGrade");
    const selectedTeacher = document.getElementById("selectedTeacher");
    const selectedYear = document.getElementById("selectedYear");

    function updateLabels() {
        selectedGrade.textContent = gradeFilter.value ? "Grade " + gradeFilter.value : "None";

        selectedTeacher.textContent =
            teacherFilter.selectedIndex > 0
                ? teacherFilter.options[teacherFilter.selectedIndex].text
                : "None";

        selectedYear.textContent = yearFilter.value || "None";
    }

    function updateResults() {
        const grade = gradeFilter.value;
        const teacher = teacherFilter.value;
        const year = yearFilter.value;
        const type = resultTypeFilter.value;

        fetch(`/admin/get_results?grade=${grade}&teacher_id=${teacher}&year=${year}&type=${type}`)
            .then(res => res.json())
            .then(data => {
                renderChart(data.top, data.avg, data.fail);

                document.getElementById("topResult").innerText = data.top;
                document.getElementById("averageResult").innerText = data.avg;
                document.getElementById("failResult").innerText = data.fail;

                updateLabels();
            })
            .catch(err => console.error("Error fetching results:", err));
    }

    gradeFilter.addEventListener("change", () => {
        let grade = gradeFilter.value;

        teacherFilter.innerHTML = `<option value="">Filter by Teacher</option>`;
        selectedTeacher.textContent = "None";

        if (grade === "") {
            updateResults();
            return;
        }

        fetch(`/admin/get_teachers_by_grade?grade=${grade}`)
            .then(res => res.json())
            .then(data => {
                data.forEach(t => {
                    let option = document.createElement("option");
                    option.value = t.teacher_id;       
                    option.textContent = t.full_name;  
                    teacherFilter.appendChild(option);
                });

                updateResults();
            });
    });

    teacherFilter.addEventListener("change", updateResults);
    yearFilter.addEventListener("change", updateResults);
    resultTypeFilter.addEventListener("change", updateResults);

    updateLabels();
});
</script>


{% endblock %}