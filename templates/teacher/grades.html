{% extends "teacher/base.html" %}
{% block content %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Grade Dashboard - Dynamic Class Performance Summary</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <!-- Load Bootstrap CSS (for components like Modal) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Load Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

    <style>
        /* --- General & Background (Tailwind-like classes) --- */
        body {
            background: #f4f7fa;
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
        }

        /* --- Header --- */
        .header {
            background: linear-gradient(90deg, #4a6cf7, #7b5dfb);
            padding: 20px;
            color: white;
            text-align: center;
            font-size: 30px;
            font-weight: 800;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            border-radius: 0 0 15px 15px;
        }

        .grade-container {
            width: 95%;
            max-width: 1200px;
            margin: 30px auto;
        }

        .grade-title {
            font-size: 24px;
            margin: 25px 0 15px;
            font-weight: 700;
            color: #3a3a3a;
            border-bottom: 2px solid #eef2ff;
            padding-bottom: 5px;
        }

        /* --- Class Card Enhancements --- */
        .class-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s, box-shadow 0.3s;
            border-left: 8px solid;
            height: 100%;
            display: flex;
            flex-direction: column;
            cursor: pointer;
        }

        .class-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.15);
        }

        /* Colors for each grade */
        .g7 {
            border-color: #1e88e5;
        }

        /* Blue */
        .g8 {
            border-color: #00c853;
        }

        /* Green */
        .g9 {
            border-color: #ab47bc;
        }

        /* Purple */

        /* Custom Header Colors for Modal */
        .header-g7 {
            background-color: #1e88e5 !important;
        }

        .header-g8 {
            background-color: #00c853 !important;
        }

        .header-g9 {
            background-color: #ab47bc !important;
        }

        /* Custom Button Color for Grade 9 (Purple) */
        .btn-g9-custom {
            background-color: #ab47bc !important;
            color: white !important;
            border-color: #ab47bc !important;
        }

        .btn-g9-custom:hover {
            background-color: #8e24aa !important;
        }

        .card-header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .class-card h4 {
            margin-bottom: 5px;
            font-weight: 700;
            color: #333;
        }

        .test-date {
            padding: 6px 10px;
            border-radius: 10px;
            display: inline-block;
            margin-top: 10px;
            font-size: 14px;
            font-weight: 500;
        }

        .subject-tag {
            display: inline-block;
            margin-right: 8px;
            padding: 5px 10px;
            font-size: 14px;
            border-radius: 20px;
            margin-bottom: 10px;
            background-color: #e9ecef;
            color: #495057;
            font-weight: 500;
        }

        .card-body-content {
            flex-grow: 1;
            margin-bottom: 15px;
        }

        .action-button {
            margin-top: 15px;
            border: none;
            font-weight: 600;
        }

        /* Result Tiles */
        .result-tile {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            text-align: center;
        }

        .result-tile h5 {
            font-size: 1rem;
            color: #6c757d;
            margin-bottom: 5px;
        }

        .result-tile h3 {
            font-weight: 700;
            margin: 0;
            font-size: 1.8rem;
        }

        /* Floating Add Button */
        #addClassButton {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            transition: transform 0.2s;
        }

        #addClassButton:hover {
            transform: scale(1.1);
        }

        /* Loading Indicator */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            transition: opacity 0.3s;
        }
    </style>
</head>

<body>
    <!-- Header Section -->
    <div class="header">
        <i class="fa-solid fa-graduation-cap"></i> Grade Performance Dashboard
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="ms-3 mb-0 text-primary fw-bold">Loading dashboard data...</p>
    </div>

    <!-- Main Dashboard Content -->
    <div class="grade-container" id="mainDashboard" style="display: none;">

        <!-- Grade 7 Section -->
        <div class="grade-title">
            <span class="text-primary">ðŸŒŸ</span> Grade 7 <span class="badge bg-primary ms-2" id="countG7">0</span>
        </div>
        <div class="row g-4" id="grade7Row">
            <!-- Class cards will be injected here -->
        </div>

        <!-- Grade 8 Section -->
        <div class="grade-title">
            <span class="text-success">ðŸŒŸ</span> Grade 8 <span class="badge bg-success ms-2" id="countG8">0</span>
        </div>
        <div class="row g-4" id="grade8Row">
            <!-- Class cards will be injected here -->
        </div>

        <!-- Grade 9 Section -->
        <div class="grade-title">
            <span style="color:#ab47bc;">ðŸŒŸ</span> Grade 9 - Graduation Year <span class="badge ms-2"
                style="background:#ab47bc;" id="countG9">0</span>
        </div>
        <div class="row g-4" id="grade9Row">
            <!-- Class cards will be injected here -->
        </div>

    </div>

    <!-- Floating Add Class Button -->
    <button id="addClassButton" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addClassModal">
        <i class="fa-solid fa-plus"></i>
    </button>

    <!-- ========================================================= -->
    <!-- Modal 1: Add New Class -->
    <!-- ========================================================= -->
    <div class="modal fade" id="addClassModal" tabindex="-1" aria-labelledby="addClassModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="addClassModalLabel"><i class="fa-solid fa-plus-circle"></i> Add New
                        Class Section</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addClassForm">
                        <div class="mb-3">
                            <label for="newClassGrade" class="form-label">Grade Level</label>
                            <select class="form-select" id="newClassGrade" required>
                                <option value="">Select Grade</option>
                                <option value="7">Grade 7</option>
                                <option value="8">Grade 8</option>
                                <option value="9">Grade 9</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="newClassSection" class="form-label">Section Letter (e.g., A, B, C)</label>
                            <input type="text" class="form-control" id="newClassSection" placeholder="e.g., D"
                                maxlength="1" required>
                            <div class="form-text">Enter a single letter for the class section.</div>
                        </div>
                        <div class="mb-3">
                            <label for="newStudentCount" class="form-label">Total Students Enrolled</label>
                            <input type="number" class="form-control" id="newStudentCount" value="30" min="10" max="50"
                                required>
                        </div>
                        <div class="mb-3">
                            <label for="newPassRate" class="form-label">Initial Pass Rate (%)</label>
                            <input type="range" class="form-range" id="newPassRate" value="80" min="50" max="100"
                                oninput="document.getElementById('passRateValue').innerText = this.value + '%'">
                            <p class="mt-2">Simulated Pass Rate: <strong id="passRateValue">80%</strong></p>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="addNewClass()">
                        <i class="fa-solid fa-save"></i> Save Class
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- ========================================================= -->
    <!-- Modal 2: Results Display Modal -->
    <!-- ========================================================= -->
    <div class="modal fade" id="resultsModal" tabindex="-1" aria-labelledby="resultsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white" id="modalHeader">
                    <h5 class="modal-title" id="resultsModalLabel"><i class="fa-solid fa-circle-info"></i> Class Details
                        and Results</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <h4 id="modalClassTitle" class="mb-3"></h4>
                    <p class="text-muted">Total Students Enrolled: <strong id="modalStudentCount"></strong></p>

                    <h5 class="mb-3">Overall Performance Snapshot:</h5>
                    <div class="row g-3" id="modalClassResults">
                        <!-- Result tiles injected here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Load Bootstrap JS for functionality (modals, etc.) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- ========================================================= -->
    <!-- Application Logic (Pure JavaScript) -->
    <!-- Uses client-side array only; no Firebase persistence, as requested. -->
    <!-- ========================================================= -->
    <script>
        // Global array to store class data - this array acts as the entire database for this session.
        let classData = [];

        // Mock data for initial population
        const initialClasses = [
            { id: 1, grade: 7, section: 'A', studentCount: 35, results: { taken: 35, pass: 88, fail: 12 }, date: '12 March' },
            { id: 2, grade: 7, section: 'B', studentCount: 32, results: { taken: 31, pass: 75, fail: 25 }, date: '18 March' },
            { id: 3, grade: 7, section: 'C', studentCount: 30, results: { taken: 30, pass: 95, fail: 5 }, date: '22 March' },

            { id: 4, grade: 8, section: 'A', studentCount: 29, results: { taken: 29, pass: 80, fail: 20 }, date: '10 April' },
            { id: 5, grade: 8, section: 'B', studentCount: 33, results: { taken: 33, pass: 72, fail: 28 }, date: '05 April' },
            { id: 6, grade: 8, section: 'C', studentCount: 33, results: { taken: 32, pass: 98, fail: 2 }, date: '05 April' },

            { id: 7, grade: 9, section: 'A', studentCount: 28, results: { taken: 28, pass: 91, fail: 9 }, date: '20 April' },
            { id: 8, grade: 9, section: 'B', studentCount: 31, results: { taken: 31, pass: 65, fail: 35 }, date: '25 April' },
            { id: 9, grade: 9, section: 'C', studentCount: 30, results: { taken: 30, pass: 87, fail: 13 }, date: '30 April' }
        ];

        // Core subjects displayed on the class cards
        const mockSubjects = ['ICT', 'Math', 'English', 'History', 'Geography'];

        // Utility to generate a unique, ascending ID for client-side storage
        function getNextClassId() {
            return classData.length > 0 ? Math.max(...classData.map(c => c.id)) + 1 : 1;
        }

        /**
         * Generates the HTML string for a single class card.
         * @param {object} classData - The class object.
         * @returns {string} The HTML for the class card.
         */
        function generateCardHtml(classData) {
            const className = `Grade ${classData.grade}${classData.section}`;
            const gradeClass = `g${classData.grade}`;
            const headerClass = `header-g${classData.grade}`;
            const studentCount = classData.studentCount;
            const results = classData.results;
            const nextTestDate = classData.date || 'TBD';

            const gradeColors = {
                // Updated G7, G8 to use a dedicated class name
                7: { badge: 'bg-primary', buttonClass: 'btn-primary', dateBg: '#e0f7fa', dateText: '#1e88e5' },
                8: { badge: 'bg-success', buttonClass: 'btn-success', dateBg: '#e8f5e9', dateText: '#00c853' },
                // Updated G9 to use the new custom class name
                9: { badge: 'style="background:#ab47bc;"', buttonClass: 'btn-g9-custom', dateBg: '#f3e5f5', dateText: '#ab47bc' }
            };

            const colors = gradeColors[classData.grade];

            // Safely encode the JSON string to prevent quotes from breaking the onclick attribute.
            const resultsJsonString = JSON.stringify(results);
            const encodedResultsString = encodeURIComponent(resultsJsonString);

            // Use the dedicated buttonClass key for the class attribute
            const buttonClass = colors.buttonClass;

            // The onclick handler now passes the encoded string.
            return `
            <div class="col-lg-4 col-md-6" data-class-id="${classData.id}">
                <div class="class-card ${gradeClass}" onclick="showClassDetails('${className}', ${studentCount}, '${encodedResultsString}', '${headerClass}')">
                    <div class="card-header-content">
                        <h4>${className}</h4>
                        <span class="badge" ${colors.badge}>${studentCount} Students</span>
                    </div>
                    <div class="card-body-content">
                        <p class="text-muted small fw-bold mb-2">Core Subjects:</p>
                        ${mockSubjects.map(sub => `<span class="subject-tag">${sub}</span>`).join('')}
                        <hr>
                        <p class="mb-1 fw-bold">Next Scheduled Test:</p>
                        <span class="test-date" style="color:${colors.dateText}; background:${colors.dateBg};">
                            <i class="fa-regular fa-calendar-check"></i> ${nextTestDate}
                        </span>
                    </div>
                    <!-- FIX: Injected buttonClass directly into the class list -->
                    <button class="btn btn-sm w-100 action-button ${buttonClass}">
                        <i class="fa-solid fa-square-poll-vertical"></i> View Results
                    </button>
                </div>
            </div>
        `;
        }

        /**
         * Renders all class cards into their respective grade rows and updates counts.
         */
        function renderDashboard() {
            const gradeRows = { 7: [], 8: [], 9: [] };
            const gradeCounts = { 7: 0, 8: 0, 9: 0 };

            // 1. Group classes by grade and generate HTML
            classData.forEach(data => {
                const grade = data.grade;
                if (gradeRows[grade]) {
                    gradeRows[grade].push(generateCardHtml(data));
                    gradeCounts[grade]++;
                }
            });

            // 2. Inject HTML into containers
            document.getElementById('grade7Row').innerHTML = gradeRows[7].join('');
            document.getElementById('grade8Row').innerHTML = gradeRows[8].join('');
            document.getElementById('grade9Row').innerHTML = gradeRows[9].join('');

            // 3. Update counts
            document.getElementById('countG7').textContent = gradeCounts[7];
            document.getElementById('countG8').textContent = gradeCounts[8];
            document.getElementById('countG9').textContent = gradeCounts[9];

            // 4. Hide loading and show dashboard
            document.getElementById('loadingOverlay').style.display = 'none';
            document.getElementById('mainDashboard').style.display = 'block';
        }

        /**
         * Generates the HTML for the result summary tiles inside the modal.
         * Exposed globally for inline card onclick use.
         * @param {number} studentCount - Total enrolled students.
         * @param {object} results - Results object {taken, pass, fail}.
         * @returns {string} HTML string for the result tiles.
         */
        window.generateResultSummary = function (studentCount, results) {
            const studentsTookTest = results.taken;
            // Calculate the number of students who passed/failed based on the percentage of those who took the test
            const studentsPassed = Math.round(studentsTookTest * (results.pass / 100));
            const studentsFailed = studentsTookTest - studentsPassed; // Use subtraction for accuracy

            return `
            <div class="col-md-4">
                <div class="result-tile bg-light">
                    <h5>Students Took Test</h5>
                    <h3 class="text-secondary">${studentsTookTest} / ${studentCount}</h3>
                </div>
            </div>
            <div class="col-md-4">
                <div class="result-tile bg-success-subtle">
                    <h5>Overall Pass %</h5>
                    <h3 class="text-success">${results.pass}% (${studentsPassed} Students)</h3>
                </div>
            </div>
            <div class="col-md-4">
                <div class="result-tile bg-danger-subtle">
                    <h5>Overall Fail %</h5>
                    <h3 class="text-danger">${results.fail}% (${studentsFailed} Students)</h3>
                </div>
            </div>
        `;
        }

        /**
         * Populates and displays the detailed results modal.
         * Exposed globally for inline card onclick use.
         * @param {string} encodedResultsString - URI-encoded JSON string of the results.
         */
        window.showClassDetails = function (className, studentCount, encodedResultsString, headerClass) {
            const modalHeader = document.getElementById('modalHeader');

            // Reset and Apply Modal Header Color
            modalHeader.classList.remove('bg-primary', 'header-g7', 'header-g8', 'header-g9');
            modalHeader.classList.add(headerClass);

            // Update the Modal Content
            document.getElementById('modalClassTitle').textContent = `Class: ${className} Results`;
            document.getElementById('modalStudentCount').textContent = studentCount;

            // Decode and Parse results string
            const resultsString = decodeURIComponent(encodedResultsString);

            try {
                const parsedResults = JSON.parse(resultsString);
                document.getElementById('modalClassResults').innerHTML = window.generateResultSummary(studentCount, parsedResults);
            } catch (e) {
                console.error("Error parsing JSON results:", e, resultsString);
                document.getElementById('modalClassResults').innerHTML = `<p class="text-danger fw-bold">Error loading results data. Check console for details.</p>`;
            }

            // Show the Bootstrap modal
            var resultsModal = new bootstrap.Modal(document.getElementById('resultsModal'));
            resultsModal.show();
        }


        /**
         * Handles form submission for adding a new class to the client-side array.
         * Exposed globally for inline button onclick use.
         */
        window.addNewClass = function () {
            const grade = document.getElementById('newClassGrade').value;
            const sectionInput = document.getElementById('newClassSection').value;
            const section = sectionInput ? sectionInput.toUpperCase() : '';
            const studentCount = parseInt(document.getElementById('newStudentCount').value);
            const passRate = parseInt(document.getElementById('newPassRate').value);

            // Simple validation
            if (!grade || !section || isNaN(studentCount) || isNaN(passRate) || section.length !== 1 || studentCount < 10 || studentCount > 50 || passRate < 50 || passRate > 100) {
                console.error("Invalid input for new class. Please check all fields.");
                // In a production app, you would show a user-friendly error message here (not alert).
                return;
            }

            const newClassData = {
                id: getNextClassId(),
                grade: parseInt(grade),
                section: section,
                studentCount: studentCount,
                // Mock data for results based on input pass rate
                results: {
                    taken: studentCount, // Assume all enrolled students took the test
                    pass: passRate,
                    fail: 100 - passRate
                },
                date: 'New Addition', // Mock date 
                createdAt: new Date().toISOString()
            };

            // Add new class to the local array
            classData.push(newClassData);
            classData.sort((a, b) => {
                // Sort by grade, then by section for consistent display
                if (a.grade !== b.grade) return a.grade - b.grade;
                return a.section.localeCompare(b.section);
            });

            // Re-render the dashboard to show the new class
            renderDashboard();

            // Close the modal upon success
            const modalElement = document.getElementById('addClassModal');
            const modal = bootstrap.Modal.getInstance(modalElement);
            if (modal) modal.hide();

            // Clear form (optional but good practice)
            document.getElementById('addClassForm').reset();
            document.getElementById('newPassRate').value = 80; // Reset range slider
            document.getElementById('passRateValue').innerText = '80%';
        }

        // --- Initialization on DOM Load ---
        document.addEventListener('DOMContentLoaded', () => {
            // 1. Initialize data array with mock classes
            classData = [...initialClasses];

            // 2. Render the initial dashboard view
            renderDashboard();

            // 3. Set initial pass rate value display for the modal form
            const passRateInput = document.getElementById('newPassRate');
            if (passRateInput) {
                document.getElementById('passRateValue').innerText = passRateInput.value + '%';
            }
        });
    </script>
</body>

</html>
{% endblock %}