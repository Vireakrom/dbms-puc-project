{% extends "teacher/base.html" %}
{% block title %}Dashboard{% endblock %}

{% block head_extra %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    /* Dashboard-Specific Styles */
    .dashboard-hero {
        background: linear-gradient(90deg, #4a6cf7, #7b5dfb);
        color: white;
        padding: 15px;
        text-align: center;
        font-size: 24px;
        font-weight: bold;
    }

    .container {
        width: 90%;
        margin: 20px auto;
    }

    .cards {
        display: flex;
        gap: 20px;
        margin-bottom: 30px;
        flex-wrap: wrap;
    }

    .cards a {
        flex: 1;
        padding: 20px;
        border-radius: 14px;
        color: white;
        text-decoration: none;
        text-align: center;
        transition: 0.3s;
        box-shadow: 0 5px 12px rgba(0, 0, 0, 0.2);
    }

    .card1 {
        background: linear-gradient(45deg, #1e88e5, #42a5f5);
    }

    .card2 {
        background: linear-gradient(45deg, #00c853, #64dd17);
    }

    .card3 {
        background: linear-gradient(45deg, #ff7043, #ff5252);
    }

    .card5 {
        background: linear-gradient(45deg, #ab47bc, #ec407a);
    }

    .cards a:hover {
        transform: scale(1.07);
        box-shadow: 0 12px 25px rgba(0, 0, 0, 0.3);
    }

    /* Upcoming Tests & Announcements Row */
    .row-box {
        display: flex;
        gap: 25px;
        margin: 30px;
        flex-wrap: wrap;
    }

    .upcoming-box {
        background: white;
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        flex: 1;
        min-width: 280px;
    }

    .test-card {
        background: #f7f8ff;
        padding: 15px 20px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        margin-bottom: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: 0.3s;
    }

    .delete-btn {
        background: #f44336;
        border: none;
        color: white;
        padding: 6px 12px;
        border-radius: 8px;
        cursor: pointer;
    }

    /* Announcements Box */
    .announcement-box {
        background: linear-gradient(135deg, #ffecd2, #fcb69f);
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
        flex: 1;
        min-width: 280px;
    }

    .announcement-box ul {
        list-style: none;
        padding-left: 0;
        margin: 0;
    }

    .announcement-box li {
        background: rgba(255, 255, 255, 0.7);
        padding: 10px 12px;
        border-radius: 10px;
        margin-bottom: 8px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }

    .result-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .result-row {
        background: rgba(255, 255, 255, 0.7);
        padding: 10px 12px;
        border-radius: 10px;
        margin-bottom: 8px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
    }

    .result-row small {
        color: #5f6368;
    }

    /* Charts */
    .charts-container {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 25px;
        margin: 40px;
    }

    .chart-box,
    .pie-box {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 5px 12px rgba(0, 0, 0, 0.15);
        text-align: center;
    }

    .muted {
        color: #708090;
    }
</style>
{% endblock %}


{% block content %}

<div class="dashboard-hero">Teacher Dashboard</div>

<div class="container">
    <div id="dashboard-error" class="alert alert-danger d-none"></div>
    <div class="cards">
        <a href="{{ url_for('teacher_students') }}" class="card1">
            <img src="https://img.icons8.com/?size=100&id=25220&format=png&color=ffffff" width="45">
            <h4>Students</h4>
            <p id="students-count" class="mb-0 muted">--</p>
        </a>
        <a href="{{ url_for('teacher_grade') }}" class="card2">
            <img src="https://img.icons8.com/?size=100&id=4910&format=png&color=ffffff" width="45">
            <h4>Classes</h4>
            <p id="classes-count" class="mb-0 muted">--</p>
        </a>
        <a href="{{ url_for('teacher_test_creation') }}" class="card3">
            <img src="https://img.icons8.com/?size=100&id=56576&format=png&color=ffffff" width="45">
            <h4>Tests</h4>
            <p id="tests-count" class="mb-0 muted">--</p>
        </a>
        <a href="{{ url_for('teacher_report') }}" class="card5">
            <img src="https://img.icons8.com/ios-filled/50/ffffff/report-card.png" width="45">
            <h4>Results</h4>
            <p id="results-count" class="mb-0 muted">--</p>
        </a>
    </div>
</div>

<div class="row-box">
    <!-- Upcoming Tests -->
    <div class="upcoming-box">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="mb-0">Upcoming Tests</h3>
            <a class="btn btn-sm btn-outline-primary" href="{{ url_for('teacher_test_creation') }}">Create</a>
        </div>
        <div id="testContainer">
            <p class="text-center text-muted">Loading...</p>
        </div>
    </div>
    <!-- Recent Results -->
    <div class="announcement-box">
        <h5>ðŸ“ˆ Recent Results</h5>
        <ul id="recentResults" class="result-list">
            <li class="text-center text-muted">Loading...</li>
        </ul>
    </div>
</div>


<div class="charts-container">
    <div class="chart-box">
        <h3>Pass / Fail per Grade</h3>
        <canvas id="passFailChart"></canvas>
    </div>

    <div class="pie-box">
        <h3>Tests Distribution (Grade 7-9)</h3>
        <canvas id="gradePieChart"></canvas>
    </div>
</div>

<script>
    const testContainer = document.getElementById("testContainer");
    const recentResultsList = document.getElementById("recentResults");
    const errorBox = document.getElementById("dashboard-error");

    let passFailChart = null;
    let gradePieChart = null;

    document.addEventListener("DOMContentLoaded", () => {
        loadDashboard();
    });

    function setText(id, text) {
        const el = document.getElementById(id);
        if (el) { el.textContent = text; }
    }

    async function loadDashboard() {
        try {
            const res = await fetch("{{ url_for('teacher_dashboard_data') }}");
            const json = await res.json();

            if (!json.ok) {
                showError(json.error || "Unable to load dashboard data.");
                return;
            }

            const data = json.data || {};
            renderSummary(data.summary || {});
            renderUpcoming(data.upcoming_tests || []);
            renderRecent(data.recent_results || []);
            renderCharts(data.pass_fail || [], data.tests_by_grade || []);
        } catch (err) {
            console.error(err);
            showError("Unable to load dashboard data.");
        }
    }

    function showError(message) {
        errorBox.classList.remove("d-none");
        errorBox.textContent = message;
    }

    function renderSummary(summary) {
        setText("students-count", `${summary.total_students || 0} Students`);
        setText("classes-count", `${summary.total_classes || 0} Classes`);
        setText("tests-count", `${summary.total_tests || 0} Tests`);
        setText("results-count", `${summary.total_results || 0} Results`);
    }

    function renderUpcoming(tests) {
        testContainer.innerHTML = "";
        if (!tests.length) {
            testContainer.innerHTML = "<p class='text-center text-muted'>No upcoming tests scheduled.</p>";
            return;
        }

        tests.forEach((t) => {
            const start = formatDateTime(t.start_time);
            const div = document.createElement("div");
            div.className = "test-card";
            div.innerHTML = `
                <div class="test-info">
                    <p class="mb-1"><strong>${escapeHtml(t.title || "Untitled Test")}</strong></p>
                    <p class="mb-0">${escapeHtml(t.subject_name || "")} Â· ${escapeHtml(t.class_name || "")}</p>
                    <small class="text-muted">${start || "Scheduled"}</small>
                </div>
            `;
            testContainer.appendChild(div);
        });
    }

    function renderRecent(results) {
        recentResultsList.innerHTML = "";
        if (!results.length) {
            recentResultsList.innerHTML = "<li class='text-center text-muted'>No recent submissions.</li>";
            return;
        }

        results.forEach((r) => {
            const when = formatDate(r.test_date);
            const score = r.grade !== null && r.grade !== undefined ? r.grade : r.score;
            const scoreText = score !== null && score !== undefined ? score : "--";
            const li = document.createElement("li");
            li.className = "result-row";
            li.innerHTML = `
                <div>
                    <strong>${escapeHtml(r.student_name || "Student")}</strong><br>
                    <small>${escapeHtml(r.subject_name || "")} Â· ${escapeHtml(r.class_name || "")}</small>
                </div>
                <div class="text-end">
                    <div class="fw-bold">${scoreText}</div>
                    <small>${when || "--"}</small>
                </div>
            `;
            recentResultsList.appendChild(li);
        });
    }

    function renderCharts(passFail, testsByGrade) {
        const passLabels = passFail.map((r) => r.class_name);
        const passData = passFail.map((r) => r.pass_count);
        const failData = passFail.map((r) => r.fail_count);

        if (passFailChart) { passFailChart.destroy(); }
        passFailChart = new Chart(document.getElementById("passFailChart"), {
            type: 'bar',
            data: {
                labels: passLabels,
                datasets: [
                    { label: 'Pass', data: passData, backgroundColor: '#4caf50' },
                    { label: 'Fail', data: failData, backgroundColor: '#f44336' }
                ]
            },
            options: { responsive: true, scales: { y: { beginAtZero: true } } }
        });

        const gradeLabels = testsByGrade.map((r) => `Grade ${r.grade_level || ''}`.trim());
        const gradeCounts = testsByGrade.map((r) => r.test_count);

        if (gradePieChart) { gradePieChart.destroy(); }
        gradePieChart = new Chart(document.getElementById("gradePieChart"), {
            type: 'pie',
            data: {
                labels: gradeLabels,
                datasets: [{ data: gradeCounts, backgroundColor: ["#4a6cf7", "#28d18e", "#f7b64a", "#ff7043"] }]
            }
        });
    }

    function formatDateTime(value) {
        if (!value) { return null; }
        const dt = new Date(value);
        if (Number.isNaN(dt.getTime())) { return null; }
        return dt.toLocaleString();
    }

    function formatDate(value) {
        if (!value) { return null; }
        const dt = new Date(value);
        if (Number.isNaN(dt.getTime())) { return null; }
        return dt.toLocaleDateString();
    }

    function escapeHtml(str) {
        if (!str && str !== 0) { return ""; }
        return `${str}`
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#39;");
    }
</script>

{% endblock %}